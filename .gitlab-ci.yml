.dev-only: &dev-only
  only:
  - develop
  - /^feature.*$/
  - /^bugfix.*$/

.gometalinter-template: &gometalinter-template
  <<: *dev-only
  image: scalify/glide:0.13.0
  stage: lint
  dependencies:
  - Get Dependencies
  variables:
    OPTIONS: --deadline=5m --vendor --disable-all --skip=proto --sort=severity
  script:
    - go get github.com/alecthomas/gometalinter
    - gometalinter -i
    - gometalinter $OPTIONS --enable=$CI_JOB_NAME ./...

before_script:
  - mkdir -p $GOPATH/src/gitlab.com/$CI_PROJECT_NAMESPACE
  - ln -s $CI_PROJECT_DIR/ $GOPATH/src/gitlab.com/$CI_PROJECT_PATH
  - cd $GOPATH/src/gitlab.com/$CI_PROJECT_PATH
  - mkdir -p ~/.kube

variables:
  CGO_ENABLED: 0

stages:
  - dependencies
  - lint
  - test
  - build

Get Dependencies:
  <<: *dev-only
  image: scalify/glide:0.13.0
  stage: dependencies
  artifacts:
    paths:
    - vendor/
    expire_in: 1 day
    untracked: true
  script:
    - glide install --strip-vendor

deadcode:
  <<: *gometalinter-template
errcheck:
  <<: *gometalinter-template
vet:
  <<: *gometalinter-template
goconst:
  <<: *gometalinter-template
gocyclo:
  <<: *gometalinter-template
  allow_failure: true
golint:
  <<: *gometalinter-template
  allow_failure: true
ineffassign:
  <<: *gometalinter-template
  allow_failure: true
misspell:
  <<: *gometalinter-template
  allow_failure: true
unparam:
  <<: *gometalinter-template
  allow_failure: true
dupl:
  <<: *gometalinter-template
  allow_failure: true
staticcheck:
  <<: *gometalinter-template
  allow_failure: true
gas:
  <<: *gometalinter-template
  allow_failure: true
lll:
  <<: *gometalinter-template
  allow_failure: true
goimports:
  <<: *gometalinter-template
  allow_failure: true
unconvert:
  <<: *gometalinter-template
  allow_failure: true
vetshadow:
  <<: *gometalinter-template
  allow_failure: true
interfacer:
  <<: *gometalinter-template
  allow_failure: true
gosimple:
  <<: *gometalinter-template
  allow_failure: true
gotype:
  <<: *gometalinter-template
  allow_failure: true
unused:
  <<: *gometalinter-template
  allow_failure: true
nakedret:
  <<: *gometalinter-template
  allow_failure: true

Test:
  image: scalify/glide:0.13.0
  stage: test
  dependencies:
  - Get Dependencies
  script:
  - go test ./...
  allow_failure: true
  <<: *dev-only

Build Application:
  image: scalify/glide:0.13.0
  stage: test
  dependencies:
  - Get Dependencies
  artifacts:
    paths:
    - $CI_PROJECT_NAME
  script:
  - GOOS=linux go build -v -ldflags '-w -extldflags '-static'' .
  <<: *dev-only

Build Image and Push Dev Tag:
  image: docker:edge-git
  stage: build
  dependencies:
  - Build Application
  script:
  - docker build -t $REGISTRY_URL/$CI_PROJECT_NAME:$CI_BUILD_REF .
  - docker push $REGISTRY_URL/$CI_PROJECT_NAME:$CI_BUILD_REF
  - docker tag $REGISTRY_URL/$CI_PROJECT_NAME:$CI_BUILD_REF $REGISTRY_URL/$CI_PROJECT_NAME:dev
  - docker push $REGISTRY_URL/$CI_PROJECT_NAME:dev
  only:
    - develop

Push Staging Tag:
  image: docker:edge-git
  stage: build
  dependencies: []
  script:
      - export HASH=$(git merge-base origin/staging origin/develop)
      - docker pull $REGISTRY_URL/$CI_PROJECT_NAME:$HASH
      - docker tag $REGISTRY_URL/$CI_PROJECT_NAME:$HASH $REGISTRY_URL/$CI_PROJECT_NAME:staging
      - docker push $REGISTRY_URL/$CI_PROJECT_NAME:staging
  only:
      - staging

Push Latest Tag:
  stage: build
  image: docker:edge-git
  dependencies: []
  script:
      - export HASH=$(git merge-base origin/master origin/develop)
      - docker pull $REGISTRY_URL/$CI_PROJECT_NAME:$HASH
      - docker tag $REGISTRY_URL/$CI_PROJECT_NAME:$HASH $REGISTRY_URL/$CI_PROJECT_NAME:latest
      - docker push $REGISTRY_URL/$CI_PROJECT_NAME:latest
  only:
      - master
